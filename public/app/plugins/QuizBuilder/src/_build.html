<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>New Quiz</title>
	<link rel="stylesheet" type="text/css" href="_build.css">

<script type="text/javascript">

// generic parts related only to this build
var qs = window.location.search.split("?")[1] ? window.location.search.split("?")[1].split(",") : ["[]",0],
	_userdata = JSON.parse(unescape(qs[0]?qs[0]:"[]")),
	_page_index = qs[1];
	window.setup = { // built dynamically using handlebars
		title: "My Quiz",
		questions: [
			{
				uid: "q1",
				media: "<p class=\"text-center\"><img src=\"http://placehold.it/400x300/?text=Circle\"></p>",
				text: "<h1>Question 1</h1><p>Consider the image above. In it, we have some text which may or may not be important when considering how you answer this question. You now need to determine what the shape is.</p>",
				show: 4,
				required: 16,
				distractors: [
					{text: "<p>1.1Trapezoid.</p>"},
					{text: "<p>1.2Rectangle</p>"},
					{text: "<p>1.3Rhomboid polynomial.</p>"},
					{text: "<p>1.4Translated sigmoidal ellipsoid.</p>"},
					{text: "<p>1.5 * Combobulated spline.</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: '',
					negative: 'You chose ... poorly'
				}
			},
			{
				uid: "q2",
				media: "<p class=\"text-center\"><img src=\"http://placehold.it/400x300/?text=question+2\"></p>",
				text: "<h1>Question 2</h1><p>Question 2's version of Corrupti dicta ratione, rerum vero perspiciatis at mollitia pariatur tenetur. Architecto natus quo aliquam, numquam illum?</p><p>Facilis reiciendis corporis ex dolor dignissimos.</p>",
				show: 4,
				required: 4,
				distractors: [
					{text: "<p>2.1Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>"},
					{text: "<p>2.2Laboriosam, voluptatem, saepe!</p>"},
					{text: "<p>2.3 * Temporibus quasi, quis adipisci impedit.</p>"},
					{text: "<p>2.4Possimus aliquid atque illum nesciunt modi molestiae sunt eum.</p>"},
					{text: "<p>2.5Sint soluta consequatur, quaerat nihil.</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: '',
					negative: 'You chose ... very poorly'
				}
			},
			{
				uid: "q3",
				text: "<h1>Question 3</h1><p>Question 3's version of Lorem ipsum dolor sit amet, consectetur adipisicing elit. Corrupti dicta ratione, rerum vero perspiciatis at mollitia pariatur tenetur. Architecto natus quo aliquam, numquam illum?</p><p>Facilis reiciendis corporis ex dolor dignissimos.</p>",
				show: 4,
				required: 22,
				distractors: [
					{text: "<p>3.1Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>"},
					{text: "<p>3.2 * Laboriosam, voluptatem, saepe!</p>"},
					{text: "<p>3.3 * Temporibus quasi, quis adipisci impedit.</p>"},
					{text: "<p>3.4Possimus aliquid atque illum nesciunt modi molestiae sunt eum.</p>"},
					{text: "<p>3.5 * Sint soluta consequatur, quaerat nihil.</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: '',
					negative: 'You still chose ... poorly'
				}
			},
			{
				uid: "q4",
				media: "<p class=\"text-center\"><iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/ZxTnogTT99k?rel=0\" frameborder=\"0\" allow=\"autoplay; encrypted-media\" allowfullscreen></iframe></p>",
				text: "<h1>Question 4</h1><p>Question 4's version of Architecto natus quo aliquam, numquam illum?</p><p>Facilis reiciendis corporis ex dolor dignissimos.</p>",
				show: 4,
				required: 8,
				distractors: [
					{text: "<p>4.1Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>"},
					{text: "<p>4.2Laboriosam, voluptatem, saepe!</p>"},
					{text: "<p>4.3Temporibus quasi, quis adipisci impedit.</p>"},
					{text: "<p>4.4 * Possimus aliquid atque illum nesciunt modi molestiae sunt eum.</p>"},
					{text: "<p>4.5Sint soluta consequatur, quaerat nihil.</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: 'OMG Finally! How long did it take you to answer one correctly?',
					negative: 'Your have choses ... poerly'
				}
			},
			{
				uid: "q5",
				media: "<p class=\"text-center\"><img src=\"http://placehold.it/400x300/?text=5+5+5+5+5\"></p>",
				text: "<h1>Question 5</h1><p>Question 5's version of Lorem ipsum dolor sit amet, consectetur adipisicing elit. Corrupti dicta ratione, rerum vero perspiciatis at mollitia pariatur tenetur. Architecto natus quo aliquam, numquam illum?</p><p>Facilis reiciendis corporis ex dolor dignissimos.</p>",
				show: 5,
				required: 16,
				distractors: [
					{text: "<p>5.1Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>"},
					{text: "<p>5.2Laboriosam, voluptatem, saepe!</p>"},
					{text: "<p>5.3Temporibus quasi, quis adipisci impedit.</p>"},
					{text: "<p>5.4Possimus aliquid atque illum nesciunt modi molestiae sunt eum.</p>"},
					{text: "<p>5.5 * Sint soluta consequatur, quaerat nihil.</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: '',
					negative: 'No'
				}
			},
			{
				uid: "q6",
				media: "",
				text: "<h1>Question 6</h1><p>Question 6 should not randomise and always display 8 distractors.</p>",
				show: 8,
				required: 1,
				distractors: [
					{text: "<p>6.1 * This is the correct answer</p>"},
					{text: "<p>6.2 This is a distraction</p>"},
					{text: "<p>6.3 This is a distraction</p>"},
					{text: "<p>6.4 This is a distraction</p>"},
					{text: "<p>6.5 This is a distraction</p>"},
					{text: "<p>6.6 This is a distraction</p>"},
					{text: "<p>6.7 This is a distraction</p>"},
					{text: "<p>6.8 This is a distraction</p>"}
				],
				feedback: {
					none: 'No answer was chosen',
					positive: '',
					negative: 'I even put the answer in the distractor for you'
				}
			}
		],
		show: 4,
		required: 4,
		randomise: true,
		resit: true,
		finished: false,
		feedback: "answer" // answer, complete, false
	};
// userdata = [["q6",1,[0,1,2,3,4,5,6,7]],["q5",0,[0,1,2,3,4]],["q1",0,[0,4,1,2]],["q3",0,[4,2,0,1]]];

/* ---- begin minification ---- */
(function(){
  var cache = {};
  this.tmpl = function tmpl(str, data){
    var fn = !/\W/.test(str) ?
      cache[str] = cache[str] ||
        tmpl(document.getElementById(str).innerHTML) :
      new Function("obj",
        "var p=[],print=function(){p.push.apply(p,arguments);};" +
        "with(obj){p.push('" +
        str
          .replace(/[\r\t\n]/g, " ")
          .split("<%").join("\t")
          .replace(/((^|%>)[^\t]*)'/g, "$1\r")
          .replace(/\t=(.*?)%>/g, "',$1,'")
          .split("\t").join("');")
          .split("%>").join("p.push('")
          .split("\r").join("\\'")
      + "');}return p.join('');");
    return data ? fn( data ) : fn;
  };
})();

// find in json
Array.prototype.find = Array.prototype.find || function(callback) {
  if (this === null) {
    throw new TypeError('Array.prototype.find called on null or undefined');
  } else if (typeof callback !== 'function') {
    throw new TypeError('callback must be a function');
  }
  var list = Object(this);
  // Makes sures is always has an positive integer as length.
  var length = list.length >>> 0;
  var thisArg = arguments[1];
  for (var i = 0; i < length; i++) {
    var element = list[i];
    if ( callback.call(thisArg, element, i, list) ) {
      return element;
    }
  }
};

// dispatch a browser event
function emitStatus(status) {
	parent.dispatchEvent(new CustomEvent("statuschange", {detail: status}));
}

// fischer-yates algorithm
function shuffle(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(Math.random()*(b+1)),_ref=[a[c],a[b]];a[b]=_ref[0],a[c]=_ref[1]}}

function get_control_type(question, l,f) {
	// the number of bits is implied by the question.required
	l = Math.floor(Math.log(question.required)/Math.LN2)+1;
	// a square can only occupy one bit, so if it's not a square, the required mask must represent multiple squares
	f = Array.apply(null, new Array(l)).map(function(_,i){return Math.pow(2,i)});
	// multiple squares = checkbox
	return (f.indexOf(question.required)===-1) ? "checkbox":"radio";
}

function initQB(userdata, quiz) {

	// 1. deep clone the "quiz" object
	var questions = JSON.parse(JSON.stringify(quiz.questions));

	// sanity checking
	if (quiz.show>questions.length) quiz.show = questions.length;
	if (quiz.required>quiz.show) quiz.required = quiz.show;

	if (userdata.length === 0) {
		// 3a. otherwise shuffle the resulting questions
		if (quiz.randomise) shuffle(questions);

		// 3b. crop the questions at the show limit
		questions.splice(quiz.show);

		// and store this in the userdata
		userdata = questions.map(function(q,i) {
			// a copy of the question distractors that contains an index and required property (which we don't want to expose)
			q.answer = 0;
			q.locked = false;
			var source = q.distractors.map(function(a,b) {
				a.index = b;
				a.required = ((q.required & Math.pow(2,b)) > 0); //????
				return a;
			}), dest =[];
			if (q.show < q.distractors.length) { // must randomise
				shuffle(source)
				for (var i=0; i < source.length; i++) {
					if (source[i].required === true) {
						dest.push(source[i].index);
					}
				}

				for (var i=dest.length; dest.length < q.show; i++) {
					if (dest.indexOf(source[i].index) === -1) { // fill remaining space with distractors
						dest.push(source[i].index);
					}
				}
				
				shuffle(dest);
			} else {
				for (var i=0; i < source.length; i++) {
					dest.push(source[i].index);
				}
			}

			return [q.uid, 0, dest]; // question-in-order, my-value, distractors-in-order
		});

	} // else the userdata exists, which means we already have the randomised question set

	emitStatus({
		index:_page_index,
		status:'init', // ialise,
		userdata:JSON.stringify(userdata),
		score:0,
		required:quiz.required
	});

	// modify questions to be in order we want to display them, and throw on some runtime values we need
	questions = userdata.map(function(value) {
		var uid = value[0],
			val = value[1], // user chosen distractor value
			q = quiz.questions.find(function(obj) {
				return (obj.uid === uid);
			}),
			result = {},
			qd = q.distractors, // question distractors
			ud = value[2], // user pre-randomised and cropped ids
			nd = []; // new distractor array
			q.answer = val;
			q.locked = (quiz.feedback==="answer" && val>0); // TODO: confirm lock logic
		for (var i=0; i<ud.length; i++) {
			var d = qd[ud[i]];
			d.value = Math.pow(2,ud[i]); // the value of the distractor which represents its position in the
			if ((val & d.value) > 0) d.checked = true;
			nd.push(d);
		}
		q.distractors = nd; // overwrite with updated distractor list, in presentation order
		return q;
	});

	// questions is now built from the modified userdata

	// build the page header from the quiz setup
	document.querySelector("header").innerHTML = tmpl("header", quiz);

	// build the navigation from the userdata
	nav = document.querySelector("nav");
	nav.addEventListener("click", navigate, false);
	nav.innerHTML = tmpl("navigation",{questions:userdata});

	function calculateScore() {
		return questions.reduce(function(accum,curr) {
			return accum+(curr.answer===curr.required?1:0);
		},0);
	}

	function provide_feedback(question) {
		var state = question.answer===0 ? "none" : question.answer===question.required ? "positive" : "negative";
		// clean up old state (might not be necessary)
		[].forEach.call(document.querySelectorAll("div.answers .positive, div.answers .none, div.answers .negative"), function (node) {
			node.classList.remove("positive","negative","none");
		})
		var existing = document.querySelector("div.answers div.feedback");
		if (existing) existing.parentNode.removeChild(existing);

		// apply new state
		var checked = document.querySelectorAll("div.answers input:checked");
		if (checked.length === 0 && question.feedback.none && question.feedback.none.length) { // apply "none" feedback
			var div = document.createElement("div");
			div.classList.add("feedback","none");
			div.innerHTML = "<p>" + question.feedback[state] + "</p>";
			document.querySelector("div.answers").appendChild(div);
		}
		[].forEach.call(checked, function (input) { // Colour in selections
			input.parentNode.classList.add(state);
		});
		if (question.feedback[state].length && checked.length > 0) { // apply positive/negative feedback
			var div = document.createElement("div");
			div.classList.add("feedback");
			div.classList.add(state);
			div.innerHTML = "<p>" + question.feedback[state] + "</p>";
			document.querySelector("div.answers").appendChild(div);
		}

		// apply feedback to nav (no none state)

		if (quiz.feedback === "answer" && !quiz_finished()) {
			var navNode = document.querySelector("nav>a.active");
			var pagenum = navNode.getAttribute("href").replace(/\#/,'');
			if (questions[pagenum].answer > 0) {
				navNode.classList.add(questions[pagenum].answer === questions[pagenum].required ? "positive" : "negative");
			}
		}
		if ((quiz.feedback === "complete" && quiz_finished()) || (quiz.feedback === "answer" && quiz_finished())) {
			var nodes = document.querySelectorAll("nav>a");
			for (var i=0; i<questions.length; i++) {
				if (questions[i].answer>0) nodes[i].classList.add(questions[i].answer===questions[i].required ? "positive" : "negative");
			}
		}
	}

	function lock_question(question) {
		question.locked = true; // having answered it
		[].forEach.call(document.querySelectorAll("div.answers input"), function (node) {
			node.setAttribute("disabled","disabled");
		});
		userdata.find(function (record) {
			return (question.uid === record[0]);
		})[1] = question.answer;
	}

	function lock_quiz() {
		questions.forEach(function(q) {
			q.locked = true;
		});
	}

	// determines if quiz is finished or not (based on locked questions)
	function quiz_finished() { // returns true if quiz is finished, false if not
		var finished = true;
		questions.forEach(function(q) { // any unlocked q's means unfinished quiz
			if (q.locked === false) { finished = false;}
		});
		return finished;
	}

	function endquiz() {
		var check = userdata.reduce(function(a,b) {return a + (b[1]>0?1:0)}, 0); // (number of answered pages) userdata might have loaded with answers already, so is more authoritative
		if (quiz_finished() === false) {
			var alert = ((quiz.feedback === "false" || quiz.feedback === "complete") && check==questions.length) ? "Do you want to finish the quiz?" : "You haven't answered all the questions. Do you want to finish the quiz?";
			if(!window.confirm(alert)) {
				var node=document.querySelector("nav>a.active"), i = [].indexOf.call(node.parentNode.children, node); // find selected node index
				return render(i);
			}
		}
		if (quiz.feedback === "complete") {
			[].forEach.call(document.querySelector("nav").children, function (node, page) {
				if (node.getAttribute("href") === "#results") return;
				var question = questions[page],
					answer = userdata.find(function (record) {
						return (question.uid === record[0]);
					})[1];
				question.locked = true;
				question.answer = answer;
				node.classList.add(question.answer===0?"none":question.answer===question.required ? "positive":"negative");
			});
		}
		[].forEach.call(document.querySelector("nav").children, function (node, index) {
			node.classList[node.getAttribute("href") === "#results" ? "add" : "remove"]("active");
		});
		var score = calculateScore();
		quiz.finished = true;
		lock_quiz();
		document.querySelector("main").innerHTML = tmpl("endpage", {
			score: score,
			total: quiz.show,
			required: quiz.required,
			resit: quiz.resit
		});

		// after template render
		var resit = document.querySelector("div.actions a[href='#resit']");
		if (resit) {
			resit.addEventListener("click", function (e) {
				e.preventDefault();
				if(window.confirm("Do you want to resit the quiz?")) {
					emitStatus({
						index:_page_index, // index in player
						status:'resit',
						userdata:[], // blank
						score:0,
						required:quiz.required
					});

					if (window.location.href.indexOf("blob") === -1) {
						window.location.href=[window.location.origin,window.location.pathname,"?%5B%5D,",_page_index].join("");
					}
					// _userdata = [];
					// window.startQuiz(_userdata);
				}
			}, false);
		}

		emitStatus({
			index:_page_index, // index in player
			status:'term', // inate
			userdata:JSON.stringify(userdata),
			score:score,
			required:quiz.required
		});
	}

	function navigate(e) {
		var href = e.target.getAttribute("href");
		if (!href) return;
		if (href==="#results") {
			endquiz();
		} else {
			var pid = ~~href.replace(/\#/,''),
				cid = ~~document.querySelector("nav>a.active").getAttribute("href").replace(/\#/,'');
			if (pid!==cid) render(pid);
		}
	}

	function render(page) {
		[].forEach.call(document.querySelector("nav").children, function (node, index) {
			node.classList[index === page ? "add" : "remove"]("active");
		});
		// find this answer from the userdata
		questions[page].answer = userdata.find(function (record) {
			return (questions[page].uid === record[0]);
		})[1];

		if (questions[page].answer > 0) {

			// lock the question if supported
			/*
			if (!questions[page].locked) {
				questions[page].locked = (quiz.feedback === "answer");
			}
			*/
			// TODO: should this not be ((value & answer)>0) ?
			questions[page].distractors.forEach(function(distractor) {
				if (distractor.value===questions[page].answer) distractor.checked = true;
			});
		}

		// draw the questions to the DOM
		document.querySelector("main").innerHTML = tmpl("main", {
			page: page,
			feedback: quiz.feedback,
			data: questions,
			action: ""
		});

		// render feedback, if available
		if (questions[page].locked && (quiz.feedback === "answer" || (quiz.feedback === "complete" && quiz_finished() === true))) {
			provide_feedback(questions[page]);
		}

		// record which distractor(s) the user has clicked
		document.querySelector(".answers").addEventListener("change", function (e) {
			var slot = userdata.find(function (record) { return (questions[page].uid === record[0]); });
			slot[1] = (e.target.getAttribute("type") === "radio") ? ~~e.target.value : [].reduce.call(document.querySelectorAll("div.answers :checked"), function(a,b) { return a + ~~b.value; }, 0);
		}, false);

		var next = document.querySelector("div.actions a[href='#next']"),
			submit = document.querySelector("div.actions a[href='#submit']");

		if (quiz.feedback === "complete" || quiz.feedback === "false") {
			if (next) next.classList.remove("hidden");
			submit.classList.add("hidden");
			next.addEventListener("click", function (e) {
				e.preventDefault();
				var question = questions[~~e.target.dataset.index];//Why floor this?
				if (question.locked) return;
				question.answer = [].reduce.call(document.querySelectorAll("div.answers input"), function (accum, curr) {
					var value = ~~curr.value,
						checked = curr.checked;

					// find question.distractors[this one] and set .checked to curr.checked
					question.distractors.find(function(obj) {
						return (obj.value === value);
					}).checked = checked;

					// return the running total of checked item values
					return accum + (checked ? value : 0);
				}, 0);

				document.querySelector("nav>a.active").nextElementSibling.click();
			}, false);
		}
		if (quiz.feedback === "answer") {
			if (next) next.addEventListener("click", function (e) {
				e.preventDefault();
				document.querySelector("nav>a.active").nextElementSibling.click();
			});
			if (questions[page].locked) {
				if (submit) submit.classList.add("hidden");
				if (next) next.classList.remove("hidden");
			}
			if (submit) submit.addEventListener("click", function (e) {
				e.preventDefault();
				var question = questions[~~e.target.dataset.index]; //page instead?
				if (question.locked) return;
				question.answer = [].reduce.call(document.querySelectorAll("div.answers input"), function (accum, curr) {
					var value = ~~curr.value,
						checked = curr.checked;

					// find question.distractors[this one] and set .checked to curr.checked
					question.distractors.find(function(obj) {
						return (obj.value === value);
					}).checked = checked;

					// return the running total of checked item values
					return accum + (checked ? value : 0);
				}, 0);
				e.target.classList.add("hidden");
				e.target.nextElementSibling.classList.remove("hidden");
				provide_feedback(question);
				lock_question(question);
				emitStatus({
					index:_page_index, // index in player
					status:'answer',
					userdata:JSON.stringify(userdata),
					score:calculateScore(),
					required:quiz.required
				});
			}, false);
		}
	}

	// start
	render(0);

};

// init quiz with an abstract copy of the setup, in case we need to re-use it
window.startQuiz = function (u) {
	initQB(u,JSON.parse(JSON.stringify(setup)));
}

window.addEventListener('load', window.startQuiz.bind(null, _userdata), false);

/* ---- end minification ----
 * e.g. use simple optimisation on
 * https://closure-compiler.appspot.com/home
*/
</script>
</head>
<body>

	<header></header>
	<nav></nav>
	<main></main>

	<script type="text/html" id="header">
		<h1><%=title%></h1>
	</script>
	<script type="text/html" id="navigation">
		<% for (var i=0; i < questions.length; i++) { %>
		<a href="#<%=i%>" class="button"><%=(i+1)%></a>
		<% } %>
		<a href="#results" class="button">Results</a>
	</script>
	<script type="text/html" id="main">
		<div class="question">
			<%=data[page].media%>
			<br>
			<%=data[page].text%>
		</div>
		<div class="answers">
			<% for (var i=0, controlType = get_control_type(data[page]); i < data[page].distractors.length; i++ ) { %>
			<label class="control control--<%=controlType%>">
				<input type="<%=controlType%>" name="answer" value="<%=data[page].distractors[i].value%>" <% if (data[page].distractors[i].checked) { %>checked="checked"<% } %> <% if (data[page].locked) { %>disabled="disabled"<% } %>/>
				<div class="answer">
					<%=data[page].distractors[i].text%>
				</div>
				<div class="control__indicator"></div>
			</label>
			<% } %>

		</div>
		<% if (feedback === "answer" && data[page].answer===0) { %>
		<div class="actions">
			<p><a href="#submit" class="button" data-index="<%=page%>">{{buttons.answer}}</a> <a href="#next" class="button ">{{buttons.next}}</a></p>
		</div>
		<% } %>
	</script>
	<script type="text/html" id="endpage">
		<p>Thanks for completing the quiz.</p>
		<p>Your score is <%=score%> out of <%=total%>, which means you <% if (score >= required) { %>passed<% } else { %>failed<% } %>.</p>
		<% if (score < required && resit) { %>
		<div class="actions resit">
			<p><a href="#resit" class="button">{{buttons.resit}}</a></p>
		</div>
		<% } %>
	</script>

</body>
</html>