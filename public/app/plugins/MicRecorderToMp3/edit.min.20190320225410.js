function isJSON(b){try{var a=JSON.parse(b);if(a&&"object"===typeof a)return!0}catch(c){}return!1}function dec2hex(d){return Number(d).toString(16)}function hex2dec(h){return parseInt(h,16)}function randomElement(ar){return ar[Math.floor(Math.random()*ar.length)]}function isset(obj){var i,max_i;if(obj===undefined)return false;for(i=1,max_i=arguments.length;i<max_i;i++){if(obj[arguments[i]]===undefined){return false}obj=obj[arguments[i]]}return true}function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)func.apply(context,args)}}Promise.settle=function(promises){var results=[];var done=promises.length;return new Promise(function(resolve){function tryResolve(i,v){results[i]=v;done=done-1;if(done==0)resolve(results)}for(var i=0;i<promises.length;i++)promises[i].then(tryResolve.bind(null,i),tryResolve.bind(null,i));if(done==0)resolve(results)})};function hexToRgb(hex){var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null}Array.prototype.asyncEach=function(iterator,done){var list=this,n=list.length,i=-1,calls=0,looping=false;var iterate=function(){calls-=1;i+=1;if(i===n){done();return}iterator(list[i],i,resume)};var loop=function(){if(looping)return;looping=true;while(calls>0)iterate();looping=false};var resume=function(){calls+=1;if(typeof setTimeout==="undefined")loop();else setTimeout(iterate,1)};resume()};if("undefined"==typeof window.Element){window.Element=function(){return{prototype:{}}}();var __getElementById=document.getElementById,__createElement=document.createElement;document.getElementById=function(a){a=__getElementById(a);for(var d in Element)a[d]=Element[d];for(var b in Element.prototype)a[b]=Element.prototype[b]};document.createElement=function(a){__createElement(a)}}Element.prototype.setAttributes=function(a){var d=function(b,a){for(var c in b)"object"==typeof b[c]&&null==b[c].dataset&&null==b[c][0]?d(b[c],a[c]):a[c]=b[c]};d(a,this)};var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};!function(a){"use strict";function b(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function c(a,b){return a<<b|a>>>32-b}function d(a,d,e,f,g,h){return b(c(b(b(d,a),b(f,h)),g),e)}function e(a,b,c,e,f,g,h){return d(b&c|~b&e,a,b,f,g,h)}function f(a,b,c,e,f,g,h){return d(b&e|c&~e,a,b,f,g,h)}function g(a,b,c,e,f,g,h){return d(b^c^e,a,b,f,g,h)}function h(a,b,c,e,f,g,h){return d(c^(b|~e),a,b,f,g,h)}function i(a,c){a[c>>5]|=128<<c%32,a[(c+64>>>9<<4)+14]=c;var d,i,j,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(d=0;d<a.length;d+=16)i=m,j=n,k=o,l=p,m=e(m,n,o,p,a[d],7,-680876936),p=e(p,m,n,o,a[d+1],12,-389564586),o=e(o,p,m,n,a[d+2],17,606105819),n=e(n,o,p,m,a[d+3],22,-1044525330),m=e(m,n,o,p,a[d+4],7,-176418897),p=e(p,m,n,o,a[d+5],12,1200080426),o=e(o,p,m,n,a[d+6],17,-1473231341),n=e(n,o,p,m,a[d+7],22,-45705983),m=e(m,n,o,p,a[d+8],7,1770035416),p=e(p,m,n,o,a[d+9],12,-1958414417),o=e(o,p,m,n,a[d+10],17,-42063),n=e(n,o,p,m,a[d+11],22,-1990404162),m=e(m,n,o,p,a[d+12],7,1804603682),p=e(p,m,n,o,a[d+13],12,-40341101),o=e(o,p,m,n,a[d+14],17,-1502002290),n=e(n,o,p,m,a[d+15],22,1236535329),m=f(m,n,o,p,a[d+1],5,-165796510),p=f(p,m,n,o,a[d+6],9,-1069501632),o=f(o,p,m,n,a[d+11],14,643717713),n=f(n,o,p,m,a[d],20,-373897302),m=f(m,n,o,p,a[d+5],5,-701558691),p=f(p,m,n,o,a[d+10],9,38016083),o=f(o,p,m,n,a[d+15],14,-660478335),n=f(n,o,p,m,a[d+4],20,-405537848),m=f(m,n,o,p,a[d+9],5,568446438),p=f(p,m,n,o,a[d+14],9,-1019803690),o=f(o,p,m,n,a[d+3],14,-187363961),n=f(n,o,p,m,a[d+8],20,1163531501),m=f(m,n,o,p,a[d+13],5,-1444681467),p=f(p,m,n,o,a[d+2],9,-51403784),o=f(o,p,m,n,a[d+7],14,1735328473),n=f(n,o,p,m,a[d+12],20,-1926607734),m=g(m,n,o,p,a[d+5],4,-378558),p=g(p,m,n,o,a[d+8],11,-2022574463),o=g(o,p,m,n,a[d+11],16,1839030562),n=g(n,o,p,m,a[d+14],23,-35309556),m=g(m,n,o,p,a[d+1],4,-1530992060),p=g(p,m,n,o,a[d+4],11,1272893353),o=g(o,p,m,n,a[d+7],16,-155497632),n=g(n,o,p,m,a[d+10],23,-1094730640),m=g(m,n,o,p,a[d+13],4,681279174),p=g(p,m,n,o,a[d],11,-358537222),o=g(o,p,m,n,a[d+3],16,-722521979),n=g(n,o,p,m,a[d+6],23,76029189),m=g(m,n,o,p,a[d+9],4,-640364487),p=g(p,m,n,o,a[d+12],11,-421815835),o=g(o,p,m,n,a[d+15],16,530742520),n=g(n,o,p,m,a[d+2],23,-995338651),m=h(m,n,o,p,a[d],6,-198630844),p=h(p,m,n,o,a[d+7],10,1126891415),o=h(o,p,m,n,a[d+14],15,-1416354905),n=h(n,o,p,m,a[d+5],21,-57434055),m=h(m,n,o,p,a[d+12],6,1700485571),p=h(p,m,n,o,a[d+3],10,-1894986606),o=h(o,p,m,n,a[d+10],15,-1051523),n=h(n,o,p,m,a[d+1],21,-2054922799),m=h(m,n,o,p,a[d+8],6,1873313359),p=h(p,m,n,o,a[d+15],10,-30611744),o=h(o,p,m,n,a[d+6],15,-1560198380),n=h(n,o,p,m,a[d+13],21,1309151649),m=h(m,n,o,p,a[d+4],6,-145523070),p=h(p,m,n,o,a[d+11],10,-1120210379),o=h(o,p,m,n,a[d+2],15,718787259),n=h(n,o,p,m,a[d+9],21,-343485551),m=b(m,i),n=b(n,j),o=b(o,k),p=b(p,l);return[m,n,o,p]}function j(a){var b,c="";for(b=0;b<32*a.length;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&255);return c}function k(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function l(a){return j(i(k(a),8*a.length))}function m(a,b){var c,d,e=k(a),f=[],g=[];for(f[15]=g[15]=void 0,e.length>16&&(e=i(e,8*a.length)),c=0;16>c;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=i(f.concat(k(b)),512+8*b.length),j(i(g.concat(d),640))}function n(a){var b,c,d="0123456789abcdef",e="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),e+=d.charAt(b>>>4&15)+d.charAt(15&b);return e}function o(a){return unescape(encodeURIComponent(a))}function p(a){return l(o(a))}function q(a){return n(p(a))}function r(a,b){return m(o(a),o(b))}function s(a,b){return n(r(a,b))}function t(a,b,c){return b?c?r(b,a):s(b,a):c?p(a):q(a)}"function"==typeof define&&define.amd?define(function(){return t}):a.md5=t}(this);function dataURItoBlob(b){var a=atob(b.split(",")[1]);b=b.split(",")[0].split(":")[1].split(";")[0];for(var d=new ArrayBuffer(a.length),e=new Uint8Array(d),c=0;c<a.length;c++)e[c]=a.charCodeAt(c);a=new DataView(d);return new Blob([a],{type:b})}function dataURItoArrayBuffer(b){var a=atob(b.split(",")[1]);b=b.split(",")[0].split(":")[1].split(";")[0];for(var d=new ArrayBuffer(a.length),e=new Uint8Array(d),c=0;c<a.length;c++)e[c]=a.charCodeAt(c);return d}function obj2url(obj){var str=[];for(var p in obj)if(obj.hasOwnProperty(p)){str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]))}return str.join("&")}function arrayBufferToBase64(buffer){var binary="";var bytes=new Uint8Array(buffer);var len=bytes.byteLength;for(var i=0;i<len;i++){binary+=String.fromCharCode(bytes[i])}return window.btoa(binary)}function base64ToArrayBuffer(base64){var binary_string=window.atob(base64);var len=binary_string.length;var bytes=new Uint8Array(len);for(var i=0;i<len;i++){bytes[i]=binary_string.charCodeAt(i)}return bytes.buffer}var getSiblings=function(elem){var siblings=[];var sibling=elem.parentNode.firstChild;for(;sibling;sibling=sibling.nextSibling){if(sibling.nodeType===1&&sibling!==elem){siblings.push(sibling)}}return siblings};function safeGetProp(obj,props,defaultValue){try{return props.split(".").reduce(function(obj,p){return obj[p]},obj)}catch(e){return defaultValue}}function PopupCenter(a,d,b,c){var e=void 0!=window.screenLeft?window.screenLeft:screen.left,f=void 0!=window.screenTop?window.screenTop:screen.top;width=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width;height=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height;a=window.open(a,d,"scrollbars=yes, width="+b+", height="+c+", top="+(height/2-c/2+f)+", left="+(width/2-b/2+e)+", resizable=yes");window.focus&&a.focus()}Handlebars.registerHelper("compare",function(g,c,e,d){var f;if(3>arguments.length)throw Error("'compare' needs 2 parameters");void 0===d&&(d=e,e=c,c="===");f={"==":function(a,b){return a==b},"===":function(a,b){return a===b},"!=":function(a,b){return a!=b},"!==":function(a,b){return a!==b},"<":function(a,b){return a<b},">":function(a,b){return a>b},"<=":function(a,b){return a<=b},">=":function(a,b){return a>=b},in:function(a,b){return-1!=b.indexOf(a)},typeof:function(a,b){return typeof a==b}};if(!f[c])throw Error("Malformed operator in 'compare'; "+c);return f[c](g,e)?d.fn(this):d.inverse(this)});Handlebars.registerHelper("json",function(context){return JSON.stringify(context)});Handlebars.registerHelper("log",function(context){console.dir(context)});window.Object.defineProperty(Element.prototype,"documentOffsetTop",{get:function(){return this.offsetTop+(this.offsetParent?this.offsetParent.documentOffsetTop:0)}});window.Object.defineProperty(Element.prototype,"documentOffsetLeft",{get:function(){return this.offsetLeft+(this.offsetParent?this.offsetParent.documentOffsetLeft:0)}});Element.prototype.empty=function(){while(this.firstChild){this.removeChild(this.firstChild)}};Element.prototype.remove=function(){this.parentElement.removeChild(this)};NodeList.prototype.remove=HTMLCollection.prototype.remove=function(){for(var i=0,len=this.length;i<len;i++){if(this[i]&&this[i].parentElement){this[i].parentElement.removeChild(this[i])}}};function isInDOMTree(a){return!!findUltimateAncestor(a).body}function findUltimateAncestor(a){for(;a.parentNode;)a=a.parentNode;return a}function xhrFields(fields){var qs=[];for(var i in fields){if(fields.hasOwnProperty(i)&&fields[i]!==null){qs.push([encodeURIComponent(i),encodeURIComponent(fields[i])].join("="))}}return qs.join("&")}if(!String.prototype.trim){(function(){var rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;String.prototype.trim=function(){return this.replace(rtrim,"")}})()}(function(){String.prototype.trimExtn=function(){return this.replace(/\..+$/,"")}})();(function(){String.prototype.trimUntilExtn=function(){return this.replace(/.*\./,"")}})();var hexToRgb=function(hex){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null};var darkOrLight=function(red,green,blue){var brightness;brightness=red*299+green*587+blue*114;brightness=brightness/255e3;if(brightness>=.5){return"#000"}else{return"#fff"}};function aspectRatio(b,c,a,d){a=Math.min(a/b,d/c);return{width:b*a,height:c*a}}localforage.config({name:"DocumentNinja"});function Clone(a){var b;if(null==a||"object"!=typeof a)return a;if(a instanceof Date)return b=new Date,b.setTime(a.getTime()),b;if(a instanceof Array){b=[];for(var c=0,d=a.length;c<d;c++)b[c]=Clone(a[c]);return b}if(a instanceof Object){b={};for(c in a)a.hasOwnProperty(c)&&(b[c]=Clone(a[c]));return b}throw Error("Unable to copy obj! Its type isn't supported.")}function getObjects(obj,key,val){var objects=[];for(var i in obj){if(!obj.hasOwnProperty(i))continue;if(typeof obj[i]=="object"){objects=objects.concat(getObjects(obj[i],key,val))}else if(i==key&&obj[i]==val||i==key&&val==""){objects.push(obj)}else if(obj[i]==val&&key==""){if(objects.lastIndexOf(obj)==-1){objects.push(obj)}}}return objects}function scrollIfNeeded(element,container){if(element.offsetTop<container.scrollTop){container.scrollTop=element.offsetTop}else{var offsetBottom=element.offsetTop+element.offsetHeight;var scrollBottom=container.scrollTop+container.offsetHeight;if(offsetBottom>scrollBottom){container.scrollTop=offsetBottom-container.offsetHeight}}}function apiProxy(){this.LMSInitialize=function(){return"true"},this.LMSFinish=function(){return"true"},this.LMSGetValue=function(param){switch(param){case"cmi.core.lesson_status":break}return""},this.LMSSetValue=function(param,value){switch(param){case"cmi.score.raw":break;case"cmi.core.lesson_location":break}return"true"},this.LMSCommit=function(param){return"true"},this.LMSGetLastError=function(){return 0},this.LMSGetErrorString=function(){return"No error"},this.LMSGetDiagnostic=function(param){return param}}var ninjaApiProxy=new apiProxy;function checkTimeSpent(data,pageIndex){var n,d,$obj=$("#timeTaken"),$score=$("#pageScore");typeof data==="object"?data.hasOwnProperty("slide")?(n=+data.slide||0,d=+data.total||0):(n=+data.seconds||0,d=+data.duration||0):(n=+data||0,d=+pageIndex||0);var pc=Math.round(n/d*100);if($score.length){$score.text(n+" of "+d+"("+pc+"%)")}else{$obj.text(formatSeconds(n)+" / "+formatSeconds(d)+" ("+pc+"%)")}}function formatSeconds(seconds){var date=new Date(1970,0,1);date.setSeconds(seconds);return date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1").replace(/^00:(.*)/,"$1")}function CancelThis(elem){$(elem).closest("li").remove();setItemOrder()}function CancelConversion(fileId){var liElem=document.querySelector("li[data-fileid='"+fileId+"']");liElem.parentNode.removeChild(liElem);setItemOrder()}window.addEventListener("statuschange",function(e){checkTimeSpent(e.detail)},false);function triggerResize(){var event;if(document.createEvent){event=document.createEvent("HTMLEvents");event.initEvent("resize",true,true)}else{event=document.createEventObject();event.eventType="resize"}event.eventName="resize";if(document.createEvent){window.dispatchEvent(event)}else{window.fireEvent("on"+event.eventType,event)}}var _g_popover_target;function closePopover(e){var b=document.querySelector("div.dn-backdrop");b.removeEventListener("click",closePopover);document.body.removeChild(b);document.body.removeChild(document.querySelector("div.dn-popover"))}function handlePopover(tgt){_g_popover_target=tgt;var rekt=tgt.getBoundingClientRect(),b=document.createElement("div");b.addEventListener("click",closePopover,false);b.classList.add("dn-backdrop");document.body.appendChild(b);b=document.createElement("div");b.classList.add("dn-popover");b.dataset.source=tgt.dataset.action;b.innerHTML=Handlebars.templates["popovers"](tgt.dataset);b.style.top=rekt.y+rekt.height+10+"px";b.style.right="calc((100vw + .5em) - "+(rekt.x+rekt.width)+"px)";document.body.appendChild(b);switch(tgt.dataset.action){case"toggle-settings":$("input[data-action='toggle-mute']").prop("checked",!DocNinja.options.MUTED);$("input[data-action='toggle-no-autosplit']").prop("checked",DocNinja.options.AUTOSPLIT);$("input[data-action='toggle-no-autoresize']").prop("checked",DocNinja.options.AUTOOPTIMISE);$("input[data-action='toggle-no-autocenter']").prop("checked",DocNinja.options.AUTOCENTER);break}if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndpop);if("init"in tgt.dataset){switch(tgt.dataset.init){case"jscolor":var picker=new jscolor(b.querySelector("button.jscolor"),{valueElement:"color_value",value:tgt.dataset.value?tgt.dataset.value:DocNinja.options.pageBackgroundColour,onFineChange:debounce(function(){previewPageBackground(this.toHEXString())},500),hash:true});break;case"scoreslider":var el=document.getElementById("score_slider");noUiSlider.create(el,{start:[el.dataset.value],tooltips:[{to:function(val){return Math.round(val)}}],range:{min:+el.dataset.min,max:+el.dataset.max},step:1,pips:{mode:"count",values:Math.max(2,el.dataset.max/7>>0),density:5}});break;case"rangeslider":var el=document.getElementById("range_slider");noUiSlider.create(el,{start:[el.dataset.value],tooltips:[{to:function(val){return Math.round(val)+"%"}}],range:{min:+el.dataset.min,max:+el.dataset.max},step:1,pips:{mode:"values",values:[1,20,40,60,80,100],density:5}});break;case"initaudio":var id=DocNinja.filePreview.CurrentFile();var audio=document.getElementById("popover_audioElement");if(audio.src){audio.classList.add("visible")}else{audio.classList.remove("visible")}localforage.getItem(id).then(function(obj){document.getElementById("popover_audioElement").src=obj.payload.mp3});break}}}function playSound(obj){Promise.resolve(obj.play()).catch(function(ex){console.dir(ex)})}function handleAction(node){var tgt=typeof node==="undefined"?_g_popover_target:node;switch(tgt.dataset.action){case"pop-help":var w=window.open(tgt.dataset.url,"_blank");w.focus();break;case"add-content":classie.addClass(document.body,"modal-add");if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndpop);break;case"close-add-content":classie.removeClass(document.body,"modal-add");break;case"import-content":classie.addClass(document.body,"modal-import");if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndpop);break;case"close-import-content":classie.removeClass(document.body,"modal-import");break;default:performAction(tgt)}}function previewPageBackground(colour){DocNinja.filePreview.Editing.ShowBgColour(colour);document.querySelector("input[name='color_value']").value=colour;DocNinja.options.pageBackgroundColour=colour}function popover_saveScore(){var id=DocNinja.filePreview.CurrentFile(),score=document.getElementById("score_slider").noUiSlider.get();localforage.getItem(id).then(function(obj){obj.score=score;closePopover();return localforage.setItem(id,obj)})}function popover_saveRange(){var id=DocNinja.filePreview.CurrentFile(),button=document.querySelector("button[data-init='rangeslider']"),score=document.getElementById("range_slider").noUiSlider.get();button.dataset.value=score;localforage.getItem(id).then(function(obj){obj.score=score;closePopover();return localforage.setItem(id,obj)})}function popover_audioUpload(file){var id=DocNinja.filePreview.CurrentFile();if(file&&file.type.indexOf("audio/mpeg")===-1&&file.type.indexOf("audio/mp3")===-1)return;var reader=new FileReader;reader.onloadend=function(event){localforage.getItem(id).then(function(obj){obj.payload.mp3=event.target.result;var updated=DocNinja.Navigation.Icons.Add.Audio(id);document.querySelector("button[data-action='set-audio']").dataset.init="initaudio";closePopover();localforage.setItem(id,obj);if(updated)window.setItemOrder()})};reader.readAsDataURL(file)}function popover_savePageBackground(){var id=DocNinja.filePreview.CurrentFile(),colour=document.querySelector("input[name='color_value']").value.replace("#","");if(document.getElementById("colourAll").checked){closePopover();return DocNinja.Page.ModifyAllPageBackgroundColours(colour)}else{localforage.getItem(id).then(function(obj){switch(obj.kind){case"plugin":case"image":obj.payload.backgroundColour=colour;break;case"url":obj=DocNinja.Page.ModifyIframeBackgroundColour(obj,colour);break;case"file":obj=DocNinja.Page.ModifyPageBackgroundColour(obj,colour);break;default:alert("UNHANLED CONDITION RED ALERT GOING TO DEFCON ZERO AARGHHseeconslefrdtls. You were not meant to see this.");console.warn(obj)}closePopover();return localforage.setItem(id,obj)})}}function popover_useRecording(mp3){var id=DocNinja.filePreview.CurrentFile();localforage.getItem(id).then(function(obj){obj.payload.mp3=mp3;var updated=DocNinja.Navigation.Icons.Add.Audio(id);document.querySelector("button[data-action='set-audio']").dataset.init="initaudio";closePopover();localforage.setItem(id,obj);if(updated)window.setItemOrder()})}function renameNode(id,a){var p=a.parentNode,text=a.textContent,inp=document.createElement("input");p.removeChild(a);inp.value=text;inp.dataset.oldValue=text;var cancelName=function(){p.removeChild(inp);var l=document.createElement("a");l.dataset.action="preview";l.setAttribute("href","javascript:;");l.textContent=inp.dataset.oldValue;p.appendChild(l);setItemOrder();inp=null;document.body.removeEventListener("click",cancelName);document.getElementById("preview-frame").contentWindow.document.body.removeEventListener("click",cancelName)};inp.onkeydown=function(evt){evt=evt||window.event;var isEscape=false,isEnter=false,tgt=evt.target;if("key"in evt){isEscape=evt.key=="Escape"||evt.key=="Esc";isEnter=evt.key=="Enter"}else{isEscape=evt.keyCode==27;isEnter=evt.keyCode==13}if(!(isEnter||isEscape))return true;if(isEnter){persistProperty(id,"name",inp.value);inp.dataset.oldValue=inp.value}cancelName()};inp.classList.add("rename-page");p.appendChild(inp);document.body.addEventListener("click",cancelName);document.getElementById("preview-frame").contentWindow.document.body.addEventListener("click",cancelName);inp.select()}function hideOverlays(cog){var classes=["drag-over","modal-add","modal-import"];if(cog)classes.push("settings");DOMTokenList.prototype.remove.apply(document.body.classList,classes)}function performAction(tgt){hideOverlays();var id=tgt.closest("[data-fileid]")?tgt.closest("[data-fileid]").dataset.fileid:DocNinja.filePreview.CurrentFile();switch(tgt.getAttribute("data-action")){case"preview":var a=tgt;if(a.timerID){clearTimeout(a.timerID);a.timerID=null;renameNode(id,a)}else{a.timerID=setTimeout(function(){a.timerID=null;DocNinja.filePreview.Select(tgt.closest("li"))},250)}break;case"item-increase":DocNinja.PurityControl.Nav.Indent(tgt.closest("li"));break;case"item-decrease":DocNinja.PurityControl.Nav.Outdent(tgt.closest("li"));break;case"upload-kloudless":DocNinja.KLOUDLESS_INPUT.choose();break;case"upload-dropbox":Dropbox.choose({success:function(files){for(var i=0;i<files.length;i++){(function(file,index){if(!file.isDir){DocNinja.fileConversion.HandleUrlUpload(file.name,file.link)}})(files[i],i)}},cancel:function(){},linkType:"direct",multiselect:true});break;case"upload-file":document.getElementById("uplControl").click();break;case"plugin-edit":localforage.getItem(id,function(err,value){var frame=document.getElementById("preview-frame");frame.removeAttribute("data-fileid");frame.setAttribute("src","plugins/"+value.plugin+"/edit.html?"+id)});break;case"plugin-view":localforage.getItem(id,function(err,value){var frame=document.getElementById("preview-frame");frame.removeAttribute("data-fileid");frame.setAttribute("src","plugins/"+value.plugin+"/view.html?"+id)});break;case"add-quiz":var newId=DocNinja.PurityControl.Nav.GetFileId(),fileInfo={name:"New Quiz",supports:["edit","view"],kind:"plugin",plugin:"QuizBuilder",depth:0,payload:{}};if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndpop);localforage.setItem(newId,fileInfo).then(function(obj){DocNinja.PurityControl.Nav.Add(DocNinja.navItems,newId,fileInfo,null,"ready");DocNinja.PurityControl.Nav.Check();DocNinja.filePreview.Select(newId);localforage.setItem("order",DocNinja.navItems.innerHTML)});break;case"process-paste":var li=document.createElement("li"),url=$("#paste-url-obj").val();$("#paste-url-obj").val("");if(url.length){if(url.indexOf("://")===-1)url="https://"+url;li.innerHTML=url;li.setAttribute("data-fileid",DocNinja.PurityControl.Nav.GetFileId());DocNinja.navItems.appendChild(li);DocNinja.fileConversion.BeginConversion(null,{url:url},li,"url","")}break;case"pop-help":PopupCenter(this.href,"Help & Documentation",650,~~($(window).height()/5*4));break;case"confirm-action":$(".confirmation","#delete-page").addClass("active");$('a[data-action="confirm-action"] span').text("Really?");break;case"cancel":$(".confirmation","#delete-page").removeClass("active");$('a[data-action="confirm-action"] span').text("Delete page?");break;case"content-editable":break;case"save-content-editable":DocNinja.filePreview.Save();DocNinja.filePreview.Editing.Disable();break;case"cancel-content-editable":DocNinja.filePreview.Editing.Disable();break;case"shrink":$(document.body).append($("<div id='blocking' />"));localforage.getItem(id,function(err,value){var data=value;var h=Hermite.init("js/workers/hermite/hermite-worker.js"),img=new Image;img.onload=function(){var ratio=aspectRatio(img.naturalWidth,img.naturalHeight,ifrCache.w,ifrCache.h);h.resize({source:img,width:ratio.width,height:ratio.height,quality:.8},function(output){$("#blocking").remove();img=null;data.payload.image=output.src;localforage.setItem(id,data,function(){DocNinja.filePreview.Reset();DocNinja.filePreview.Preview(document.querySelector("li[data-fileid='"+id+"']"))})})};img.src=data.payload.image});break;case"trash":trashPage(id);break;case"split":$(document.body).append($("<div id='blocking' />"));localforage.getItem(id,function(err,obj){var n=document.querySelector("li[data-fileid='"+id+"']");DocNinja.Page.Split(n,obj).then(function(result){n.parentNode.removeChild(n);setItemOrder();DocNinja.filePreview.Reset();$("#blocking").remove();localforage.removeItem(id)})});break;case"clear-storage":localforage.clear(function(err){document.getElementById("fiddle").innerHTML="";$("#nav-colour").attr("style","");DocNinja.filePreview.Reset();DocNinja.navItems.innerHTML="";if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndtrash);DocNinja.PurityControl.Nav.Check();$("form").each(function(){this.reset()});$(document.body).removeClass("change-settings download-zip").addClass("add-documents");$("button[data-action='add-content']").click()});break;case"record-page-audio":if(!document.getElementById("audiorecorder-frame")){var rfrm=document.createElement("iframe");rfrm.setAttribute("seamless",true);rfrm.setAttribute("id","audiorecorder-frame");rfrm.setAttribute("src","/app/plugins/MicRecorderToMp3/edit.html");document.querySelector('div[data-source="set-audio"]>section').appendChild(rfrm)}break;case"upload-page-audio":document.getElementById("pageAudioUpload").click();break;case"trash-page-audio":var ae=document.getElementById("popover_audioElement");localforage.getItem(id).then(function(obj){obj.payload.mp3=undefined;delete obj.payload.mp3;ae.pause();ae.removeAttribute("src");var updated=DocNinja.Navigation.Icons.Remove.Audio(id);if(ae.hasOwnProperty("currentSrc"))ae.currentSrc=undefined;document.querySelector("button[data-action='set-audio']").removeAttribute("data-init");closePopover();localforage.setItem(id,obj);if(updated)window.setItemOrder()});break}}function trashPage(id){localforage.removeItem(id,function(err){$("li[data-fileid='"+id+"']").remove();DocNinja.filePreview.Reset();if(!DocNinja.options.MUTED)playSound(DocNinja.options.sndtrash);setItemOrder()});localforage.iterate(function(value,key){if(key.indexOf("file://"+id+":")!==-1){localforage.removeItem(key)}})}function globalClickConsumer(e){var tgt=e.target.closest("[data-action],[data-popover],[data-tab]");if(!tgt)return;if("popover"in tgt.dataset){handlePopover(tgt)}else if("action"in tgt.dataset){handleAction(tgt)}else if("tab"in tgt.dataset){changeTab(e)}}function changeTab(e){var tab=e.target.closest("a").dataset.tab;hideOverlays();e.preventDefault();DocNinja.options.loader.show();document.body.classList.remove("settings");if(!DocNinja.options.MUTED)playSound(DocNinja.options.snd);DocNinja.filePreview.Reset();$("li",DocNinja.navItems).removeClass("selected");setTimeout(function(){document.body.classList.remove("add-documents","change-settings","download-zip","undefined");document.body.classList.add(tab);triggerResize();DocNinja.options.loader.hide();DocNinja.routines.PersistSettings("change tab")},DocNinja.options.tabSpeed)}function persistProperty(fileId,propertyName,propertyValue){localforage.getItem(fileId,function(err,value){var data=value||{};data[propertyName]=propertyValue;localforage.setItem(fileId,data)})}function audioVisualize(canvas,stream){var audioCtx=new(window.AudioContext||webkitAudioContext);var source=audioCtx.createMediaStreamSource(stream);var canvasCtx=canvas.getContext("2d");var analyser=audioCtx.createAnalyser();analyser.fftSize=2048;var bufferLength=analyser.frequencyBinCount;var dataArray=new Uint8Array(bufferLength);source.connect(analyser);draw();function draw(){WIDTH=canvas.width;HEIGHT=canvas.height;requestAnimationFrame(draw);analyser.getByteTimeDomainData(dataArray);canvasCtx.fillStyle="rgb(34, 46, 70)";canvasCtx.fillRect(0,0,WIDTH,HEIGHT);canvasCtx.lineWidth=2;canvasCtx.strokeStyle="rgb(87, 183, 220)";canvasCtx.beginPath();var sliceWidth=WIDTH*1/bufferLength;var x=0;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128;var y=v*HEIGHT/2;if(i===0){canvasCtx.moveTo(x,y)}else{canvasCtx.lineTo(x,y)}x+=sliceWidth}canvasCtx.lineTo(canvas.width,canvas.height/2);canvasCtx.stroke()}}"use strict";var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var rec=document.querySelector('button[title="Record"]'),audio=document.querySelector("audio"),accept=document.querySelector('button[title="Use"]'),osc=document.getElementById("oscilloscope"),recorder=new MicRecorder,dataBlob;rec.addEventListener("click",startRecording);function startRecording(){recorder.start().then(function(stream){rec.classList.add("live");osc.classList.add("visible");audio.classList.remove("visible");audioVisualize(osc,stream);rec.removeEventListener("click",startRecording);rec.addEventListener("click",stopRecording);rec.innerHTML='<i class="material-icons">fiber_manual_record</i> Stop';accept.removeEventListener("click",useRecording);accept.classList.remove("visible")}).catch(function(e){console.error(e)})}function stopRecording(){recorder.stop().getMp3().then(function(_ref){var _ref2=_slicedToArray(_ref,2),buffer=_ref2[0];dataBlob=_ref2[1];var file=new File(buffer,"music.mp3",{type:dataBlob.type,lastModified:Date.now()});audio.src=URL.createObjectURL(file);rec.classList.remove("live");rec.innerHTML='<i class="material-icons">fiber_manual_record</i> Start';osc.classList.remove("visible");audio.classList.add("visible");accept.classList.add("visible");rec.removeEventListener("click",stopRecording);rec.addEventListener("click",startRecording);accept.addEventListener("click",useRecording)}).catch(function(e){console.error(e)})}function useRecording(){var reader=new FileReader;reader.onload=function(event){if(parent&&typeof parent.popover_useRecording!=="undefined")parent.popover_useRecording(reader.result)};reader.readAsDataURL(dataBlob)}